* Org Calendar Server
:PROPERTIES:
:TOC:      :include all :depth 3
:END:

This project is intended to serve iCal files based off of a user's org files. Org files are synced automatically from a git repo, parsed using user-defined "views", and served as tokenized .ics endpoints. This project also includes an optional frontend, to streamline access to these endpoints.

The inspiration for this effort came primarily from [[https://calendar.online]], which I used for some time. Calendar.online allows you to create free, public iCal calendars, then share them with relatively fine-grained visibility settings. I wanted to be able to replicate some of this functionality within org-mode, since I sometimes have a need to share calendar information with family/friends, but may not want to share every detail of my schedule with them.

:CONTENTS:
- [[#org-calendar-server][Org Calendar Server]]
- [[#backend][Backend]]
  - [[#setup][Setup]]
  - [[#usage][Usage]]
    - [[#views-file][Views File]]
  - [[#endpoints][Endpoints]]
    - [[#health][Health]]
    - [[#authentication][Authentication]]
    - [[#admin-actions][Admin Actions]]
    - [[#view-data][View Data]]
    - [[#per-view-data][Per-View Data]]
- [[#frontend][Frontend]]
  - [[#setup][Setup]]
  - [[#endpoints][Endpoints]]
    - [[#navigation][Navigation]]
    - [[#authentication][Authentication]]
    - [[#calendar-views-per-token][Calendar Views (per-token)]]
    - [[#proxy][Proxy]]
- [[#examples][Examples]]
- [[#how-it-works][How it Works]]
- [[#contributing][Contributing]]
:END:

* Backend
The backend handles git syncing, org parsing, ICS generation, and view logic.

** Setup
Most of the setup for the backend occurs within the docker-compose.yml file.

#+begin_src
  services:
    backend:
      image: ghcr.io/csj7701/org-calendar-backend:latest
      container_name: org-calendar-backend
      volumes:
        - ./data:/data
        - ./views.lisp:/backend/views.lisp
      ports:
        - "8000:8000"
      env_file:
        - .env
#+end_src

The example above showcases the bare-minimum setup you need to get the backend container running.
You do not have to use a .env file - you /can/ specify the environment variables directly in the docker-compose file, but I find it easier to consolidate environment variables in the .env file if you plan on using the frontend container as well. All environment variables are specified and explained later.
When defining the volumes, note the =./views.lisp:/backend/views.lisp= entry. This can be changed to whatever you like - =./views.lisp= in the example above refers to a "views.lisp" file in the same directory as the docker-compose file. You can replace this with a path (absolute, or relative to the docker-compose file) to the file defining your views. =/backend/views.lisp= refers to the location this file will be mounted within your container - this will be relevant for the environment variables you define.

/NOTE:/ Org files are accessed through git. If you plan on syncing a git repo via SSH, you will need to ensure that your ssh token is imported into the container. This can be done with an additional entry to the 'volumes' section (edit as necessary):
=- ~/.ssh/id_rsa:/ssh/id_rsa:ro=
This is not necessary if you are accessing your git repo via HTTPS.

** Usage
Once the container is set up in docker-compose, you need some additional configuration before you start the service for the first time. You will need to specify some environment variables (either in a .env file, or directly in the docker-compose file), and you will need to create your 'views' file and populate it with at least one view definition.

*Environment Variables*

- REPO_URL
  
  _Required_. This variable specifies the url with which to sync your org files.
  Example: https://github.com/username/org-files.git

- REPO_BRANCH
  
  _Required_. The branch within your git repo to sync.
  Example: 'main' or 'master'

- ORG_FILES

  _Required_. The specific files within your git repo to look for. These must be comma separated absolute paths relative to the container root (they will be prefixed with =/data/repo= by default).
  Example: "/data/repo/Agenda.org,/data/repo/Calendar.org"

- VIEWS_FILE'
  
  _Required_. The path to your 'views' file. This must be an absolute path relative to the container root. This will depend on your docker-compose file somewhat - if you define a volume as =./views.lisp:/backend/views.lisp=, then the path you should use for this variable will be "/backend/views.lisp".

- ADMIN_PASSWORD
  
  _Required_ for access to admin endpoints.
  Example: "password"

- SECRET_KEY
  
  _Required_. This is the secret key for cookie authentication. Should be obscure.
  Example: "change-me" (a better example would be "xa17db3fb" or similar)

- GITHUB_TOKEN
  
  _Required_ if syncing to a private git repo via HTTPS.
  This is your github personal access token.

- SYNC_INTERVAL_SECONDS
  
  _Required_. This defines the time interval between automatic sync attempts.
  Example: 300

- TIMEZONE

  _Optional_. This defines the timezone events should be shown in. This defaults to UTC, so unless you want all your data shown with UTC times, this is a soft requirement.
  
*** Views File  

The views file syntax is lisp-like, and is based on 3 basic objects - a "view" (essentially defines what a single endpoint will provide), a "calendar" (primarily handles event coloring/category, if your ics client supports this), and a "query" (handles the parsing - defines what will populate within each calendar/view). An example is shown below.

*View*

The 'view' object accepts 3 parameters, and must contain /only/ one or more calendar objects.
- =:name= is required, and denotes the name of the view. This accepts any string.
- =:token= is required, and denotes the token id that represents the view (this is what makes up the unique url). This accepts any string (technically), but will only function as a URL if all characters are url-safe.
- =:detail= is optional, and represents the default level of detail for this view. This accepts one of 3 values - 'full', 'time-only', and 'summary-only'. Full passes all ics information to the client (this is the default). Time-only passes only the time information to the client, replacing the summary with "Busy". Summary-only serves no additional purpose, but may be implemented more in the future, if events are expanded to support additional metadata.

*Calendar*

The 'calendar' object accepts 3 parameters, and must contain /only/ one or more query objects.
- =:name= is required, and denotes a name for the calendar. In practice, this specifies the 'categories' field in the ics data. This accepts any value.
- =:color= is optional, and denotes the color with which to represent this calendar. It is largely up to the ics client to read this data from the ics data. Accepted values will depend on the client, but in most cases should be limited to hex codes.
- =:detail= is optional, and denotes the default level of detail for this calendar. See the matching parameter under the 'view' object for more information.

*Query*

The 'query' object accepts a =:detail= parameter, and must contain exactly /one/ filter expression. Valid filter operators include the following:
- =and=: 'AND' junction between two other queries
- =or=: 'OR' junction between two other queries
- =not=: negates another filter
- =tag=: queries for entries with matching tags
- =todo=: queries for entries with a matching TODO state
- =kind=: queries for entries with a matching "kind" value (event or todo). In this case, a "task" is anything with a todo state, or a scheduled or deadline property. "Events" are everything else.
- =file=: queries for entries from a matching file
- =scheduled_after=: queries for entries with a scheduled property after the specified date
- =scheduled_before=: queries for entries with a scheduled property before the specified date
- =deadline_after=: queries for entries with a deadline property after the specified date
- =deadline_before=: queries for entries with a deadline property before the specified date


** Endpoints
The backend exposes several categories of endpoints: health, authentication, admin utilities, view data, and ICS generation.

*** Health
- =GET /healthz=: Returns a simple JSON payload indicating the server is running.
*** Authentication
- =POST /login=: Validates the admin password. Returns a session cookie on success.
- =GET /verify-session=: Verifies whether the current session cookie is valid. Returns 200 if valid, 401 if invalid.
*** Admin Actions
All admin endpoints require a valid session cookie. Rate-limited.
- =POST /admin/sync=: Immediately triggers a git sync and parse cycle
- =POST /admin/import=: Imports all org files into the database. /Parameter:/ =refresh= (boolean) - wipe DB before import.
- =GET /admin/calendar.ics=: Generates a full ICS file of *all* tasks/events in the database.
- =GET /admin/views=: Returns all parsed views from the views file.
*** View Data
- =GET /view/{token}=: Returns the definition of the specified view
*** Per-View Data
These endpoints expose data after applying your filters (view + calendar + query).

- =GET /calendar/{token}/tasks.json=: Returns JSON for all tasks matching the view. (WIP: currently returns both tasks and events)
- =GET /calendar/{token}/events.json=: Returns JSON for all events matching the view. (WIP: currently returns both tasks and events)
- =GET /calendar/{token}.ics=: Returns a multi-calendar ICS feed containing all events/todos in that view.
  
* Frontend
The frontend provides an optional, lightweight UI for interacting with the server. It allows you to:
- Access your defined views with isolated, tokenized URLs
- View calendar events and todos, either together or separately
- Access a password protected admin dashboard, which shows all events/todos and allows you to browse your defined views


The frontend does not modify org files; all edits still occur in your repository.

** Setup
As with the backend container, most of the setup for the frontend occurs within the docker-compose file.

#+begin_src
  services:
    backend:
      # Backend configuration goes here
      # The name you use here is important - if you change this from "backend:" you must update "BACKEND_URL" to match.
    frontend:
      image: ghcr.io/csj7701/org-calendar-frontend:latest
      container_name: org-calendar-frontend
      ports:
        - "8001:8000"
      env_file:
        - .env
      environment:
        - BACKEND_URL=http://backend:8000
#+end_src

This showcases the minimal required configuration necessary to get the frontend container running. As with the backend container, you do not /have/ to use a .env file (in fact, with the above example it is not necessary - =BACKEND_URL= is the only environment variable the frontend requires to run).
The =BACKEND_URL= variable should not be changed unless you know what you are doing (or unless you changed the internal container name) - this is a docker-internal route that the frontend relies on to access the backend container endpoints. Change the port definition as needed (if you want to access your frontend on port 8005 for example, change this to "8005:8000" - the port just can't conflict with the port you expose for the backend.

** Endpoints

*** Navigation
- =GET /=: Redirects to the home page (=/home=)
- =GET /home=: Dashboard view
- =GET /events=: Displays the default calendar's events
- =GET /tasks=: Displays the default calendar's tasks
- =GET /views=: Lists all backend-defined views
- =GET /settings=: Displays frontend config settings
- =POST /settings=: Saves updates settings

*** Authentication
- =GET /login=: Login page
- =POST /login=: Submits admin password; forwards to backend =/login= and mirrors session cookies
- =GET /logout=: Clears session cookie and redirects to =/login=.

*** Calendar Views (per-token)
- =GET /calendar/{token}=: Displays a dashboard for the specified view
- =GET /calendar/{token}/events=: Displays the view's events
- =GET /calendar/{token}/tasks=: Displays the view's tasks

*** Proxy
- =/proxy/{path}= (all HTTP methods): A general-purpose reverse proxy that forwards any request under =/proxy/*= to the backend. This is used to access backend ICS feeds and view JSON while preserving authentication cookies.

* Examples

Example: *Docker-Compose.yml*

#+begin_src yaml
  services:
    backend:
      image: ghcr.io/csj7701/org-calendar-backend:latest
      container_name: org-calendar-backend
      volumes:
        - ./data:/data
        - ./views.lisp:/backend/views.lisp # User created
      ports:
        - "8000:8000"
      env_file:
        - .env # User created

    frontend:
      image: ghcr.io/csj7701/org-calendar-frontend:latest
      container_name: org-calendar-frontend
      ports:
        - "8001:8000"
      environment:
        - BACKEND_URL=http://backend:8000
#+end_src

Example: *.env*

#+begin_src
REPO_URL=https://github.com/USERNAME/org.git
REPO_BRANCH=master
ORG_FILES="/data/repo/Agenda.org,/data/repo/Inbox.org,/data/repo/Calendar.org"
VIEWS_FILE="/backend/views.lisp"
GITHUB_TOKEN=ghp_XXX123
#+end_src

Example: *Views.lisp*

#+begin_src lisp
(view
 :name "Todos"
 :token "1"
 ; token "1" means that the url to access this view will be "http://host:frontend_port/calendar/1" or "http://host:backend_port/calendar/1.ics"
 (calendar
  :name "Todos"
  :color "#ff0000"
  (query
   :detail "full"
   (kind "task"))))

(view
 :name "Events"
 :token "2"
 (calendar
  :name "Events"
  :color "#00ffff"
  (query
   :detail "full"
   (kind "event"))))

(view
 :name "Multi"
 :token "3"
 :detail "time-only"
 (calendar
  :name "Multi"
  (query
   :detail "full"
   (and
    (file "/data/repo/Calendar.org")
    (kind "task")))
  ;; File needs to be absolute, relative to project root
  (query
   :detail "time-only"
   (and
    (file "/data/repo/Calendar.org")
    (kind "event")))))

(view
 :name "Admin"
 :token "4"
 :detail "full"
 (calendar :name "Work" :color "#4169e1"
	   (query
	    (tag "Work")))
 (calendar :name "Personal" :color "#228b22"
	   (query
	    (tag "Personal")))
 (calendar :name "Family" :color "#9370db"
	   (query
	    (tag "Family")))
 (calendar :name "School" :color "#f4a460"
	   (query
	    (tag "School"))))

(view
 :name "Public"
 :token "Po0jj8ZgUs2m"
 :detail "full"
 (calendar :name "Work" :color "#4682b4"
	   (query
	    (tag "Work")))
 (calendar :name "Personal" :color "#2e8b57" :detail "time-only"
	   (query
	    (tag "Personal")))
 (calendar :name "Family" :color "#6a5acd"
	   (query
	    (tag "Family"))))
#+end_src

Example: *Frontend*

[[file:./assets/Calendar.jpg]]

* How it Works
A high-level overview:

1. *Sync Cycle*: The backend periodically syncs your git repository using the configured branch and credentials.

2. *Parsing*: The org files specified in `ORG_FILES` are parsed into normalized task/event JSON objects. The parser extracts: TODO states, tags, timestamps, scheduled entries, deadlines, repeaters, warnings, and raw text. (/NOTE/: Currently, the ICS parser does not handle repeaters/warnings, so even though these are parsed from ORG to JSON, they are not parsed from JSON to ICS. This is primarily because fullcalendar has only limited client-side support for recurring events, and I have not yet found an elegant way to handle this)

3. *Database Import*: The parsed data is stored in a local SQLite database for fast lookup and stable ICS generation.

4. *View Evaluation*: Each view applies its filters (queries) to determine which entries belong in each calendar. Calendars can optionally specify colors or detail levels.

5. *ICS Generation*: Each view becomes an endpoint at: /calendar/<token>.ics. The server emits valid VEVENT/VTODO components based on the normalized data.

6. *Frontend* (optional): A small UI provides insight into sync status and parsed data.

* Contributing
Contributions are welcome. Input, bug reports, and improvements to parsing or ICS generation are appreciated.
